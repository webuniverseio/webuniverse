<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Web Universe]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://webuniverse.io/"/>
  <updated>2015-03-14T20:32:40.874Z</updated>
  <id>http://webuniverse.io/</id>
  
  <author>
    <name><![CDATA[Sergey Zarouski]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[CSS organization, naming conventions and safe extend without preprocessors]]></title>
    <link href="http://webuniverse.io/css-organization-naming-conventions-and-safe-extend-without-preprocessors/"/>
    <id>http://webuniverse.io/css-organization-naming-conventions-and-safe-extend-without-preprocessors/</id>
    <published>2015-03-14T18:37:31.000Z</published>
    <updated>2015-03-14T20:32:40.874Z</updated>
    <content type="html"><![CDATA[<p>Maintainability of CSS project highly depends on developer’s choices, on how a project was originally planned. Due to CSS cascading nature, it is easy to end up in a situation when you try to fix or add one thing, which breaks something else. In worst case scenario the issue will stay unnoticed and end up going to production. It is especially hard to work on purely organized css in a large team (a case where large team has access to CSS files is <a href="https://css-tricks.com/poll-wrapup-the-number-of-people-touching-css/" target="_blank" rel="external">not too common</a>, but is still valid).</p>
<h2 id="BEM_(or_better_GRM)">BEM (or better GRM)</h2><p>Good news is that there are battle tested tools and approaches which help to keep things under control. One of them is the famous <a href="https://en.bem.info/" target="_blank" rel="external">BEM</a>. Lets take a look at the following example:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"shopping-cart-item"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"content special-offer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h2</span> <span class="attribute">class</span>=<span class="value">"title"</span>&gt;</span>Title<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>If at some point you’ll need to remove whole <code>.content</code> block from CSS which has nested <code>.title</code>, you’ll need to check if <code>.special-offer</code> or even <code>.shopping-cart-item</code> (and other ancestors) also have a nested <code>.title</code>.</p>
<p>Now lets take a look at one of the ways to write the same with BEM:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"container container__shopping-cart"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"container__content container__content--special-offer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h2</span> <span class="attribute">class</span>=<span class="value">"container__title"</span>&gt;</span>Title<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>By looking at this, we immediately know the relationship of each of the elements and can safely do clean up, if we need to remove some styles. BEM is an abbreviation for Block, Element, Modifier and in the example above we can tell that <code>container</code> is a Block, <code>shopping-cart</code>, <code>content</code> and <code>title</code> are Elements and <code>special-offer</code> is a Modifier. While approach is great, it sounds a bit weird to call <code>container</code> a Block and <code>shoppint-cart</code> an Element. When someone mentions BEM as an approach for selectors naming, I like to translate it to <strong>GRM</strong> - Group, Role, Modifier. Lets read it again: <code>container</code> is a Group, <code>shopping-cart</code>, <code>content</code> and <code>title</code> define Roles within a Group, and <code>special-offer</code> is a Modifier.</p>
<h2 id="To_extend_or_not_to_extend?">To extend or not to extend?</h2><p>Though there is something that is not too pretty in the example above. Having duplicated classes feels redundant. Lets see what we can do about it. For html example above styles typically look similar to following:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.container</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">border</span>:<span class="value"> <span class="number">1px</span> solid grey</span></span>;</span><br><span class="line">  <span class="rule"><span class="attribute">padding</span>:<span class="value"> <span class="number">10px</span></span></span>;</span><br><span class="line">  <span class="rule"><span class="attribute">font-family</span>:<span class="value"> Arial, sans-serif</span></span>;</span><br><span class="line"><span class="rule">&#125;</span></span></span><br><span class="line">  <span class="class">.container__shopping-cart</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">border</span>:<span class="value"> <span class="number">4px</span> solid orange</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">background-color</span>:<span class="value"> <span class="hexcolor">#eee</span></span></span>;</span><br><span class="line">  <span class="rule">&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>If one use preprocessors we could illuminate a need for duplicated classes using extends. Here is how you can use it with SCSS:<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">border</span><span class="value">: <span class="number">1px</span> solid grey;</span></span><br><span class="line">  <span class="attribute">padding</span><span class="value">: <span class="number">10px</span>;</span></span><br><span class="line">  <span class="attribute">font-family</span><span class="value">: Arial, sans-serif;</span></span><br><span class="line">&#125;</span><br><span class="line">  <span class="class">.container__shopping-cart</span> &#123;</span><br><span class="line">    <span class="at_rule">@<span class="keyword">extend</span><span class="preprocessor"> .container</span>;</span></span><br><span class="line">    <span class="attribute">border</span><span class="value">: <span class="number">4px</span> solid orange;</span></span><br><span class="line">    <span class="attribute">background-color</span><span class="value">: <span class="hexcolor">#eee</span>;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>And generated result:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.container</span>, <span class="class">.container__shopping-cart</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">border</span>:<span class="value"> <span class="number">1px</span> solid grey</span></span>;</span><br><span class="line">  <span class="rule"><span class="attribute">padding</span>:<span class="value"> <span class="number">10px</span></span></span>;</span><br><span class="line">  <span class="rule"><span class="attribute">font-family</span>:<span class="value"> Arial, sans-serif</span></span>;</span><br><span class="line"><span class="rule">&#125;</span></span></span><br><span class="line">  <span class="class">.container__shopping-cart</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">border</span>:<span class="value"> <span class="number">4px</span> solid orange</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">background-color</span>:<span class="value"> <span class="hexcolor">#eee</span></span></span>;</span><br><span class="line">  <span class="rule">&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>Looks nice, now we can use both <code>.container</code> and <code>.container__shopping-cart</code> independently and CSS result still looks good. However <code>@extend</code> should be used carefully, as it might significantly increase the size of your CSS file or <a href="http://csswizardry.com/2014/11/when-to-use-extend-when-to-use-a-mixin/" target="_blank" rel="external">jumble specificity</a>.</p>
<p>So what can we do here to take advantage of behaviour which <code>@extend</code> gives us, but without any risk? Here is a pure CSS solution:<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.container</span>, <span class="attr_selector">[class^="container__"]</span>, <span class="attr_selector">[class*=" container__"]</span> &#123;</span><br><span class="line">  <span class="attribute">border</span><span class="value">: <span class="number">1px</span> solid grey;</span></span><br><span class="line">  <span class="attribute">padding</span><span class="value">: <span class="number">10px</span>;</span></span><br><span class="line">  <span class="attribute">font-family</span><span class="value">: Arial, sans-serif;</span></span><br><span class="line">&#125;</span><br><span class="line">  <span class="class">.container__shopping-cart</span> &#123;</span><br><span class="line">    <span class="at_rule">@<span class="keyword">extend</span><span class="preprocessor"> .container</span>;</span></span><br><span class="line">    <span class="attribute">border</span><span class="value">: <span class="number">4px</span> solid orange;</span></span><br><span class="line">    <span class="attribute">background-color</span><span class="value">: <span class="hexcolor">#eee</span>;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p> It is going to work because in BEM all modifiers start with <code>%base%__</code> and pretty much the only time when you want to extend something is when you need to take base styles and modify them in a way. <code>[class^=&quot;container__&quot;]</code> is taking care of a case when classname starts with selector, while <code>[class*=&quot; container__&quot;]</code> takes care of cases when selector is in the middle or at the end of classname. I noticed that <a href="https://icomoon.io/" target="_blank" rel="external">iconmoon</a> icon font generator is using that approach too. So now html could be simplified to following:<br> <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"container__shopping-cart"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"container__content--special-offer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h2</span> <span class="attribute">class</span>=<span class="value">"container__title"</span>&gt;</span>Title<span class="tag">&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Project_organization_tips">Project organization tips</h2><p> <a href="https://github.com/inuitcss/getting-started" target="_blank" rel="external">Inuit css</a> is a great example of how css project could be organized. You don’t have to use styles from inuit if you don’t want to. As long as you follow the same <em>simple</em> rules as outlined in getting started guide, your components will be reusable, while project will be scalable and maintainable. Note how files in inuit are namespaced, you’ll get similar benefits as described in an article <a href="http://csswizardry.com/2015/03/more-transparent-ui-code-with-namespaces/" target="_blank" rel="external">More Transparent UI Code with Namespaces</a>, and you don’t necessary have to prefix all your classnames with namespaces. </p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Maintainability of CSS project highly depends on developer’s choices, on how a project was originally planned. Due to CSS cascading natur]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Asynchronous programming with ES6 generators, promises and npm-co]]></title>
    <link href="http://webuniverse.io/asynchronous-programming-with-ES6-generators-promises-and-npm-co/"/>
    <id>http://webuniverse.io/asynchronous-programming-with-ES6-generators-promises-and-npm-co/</id>
    <published>2015-02-03T23:20:00.000Z</published>
    <updated>2015-03-14T01:40:23.418Z</updated>
    <content type="html"><![CDATA[<p>This article explains what an npm <code>co</code> module is, how it works and how it can help you to write much cleaner and simpler asynchronous code.</p>
<h2 id="The_problem">The problem</h2><p>Writing asynchronous code could be very tricky, if you never did it before or didn’t learn or develop good patterns to approach it. Asynchronous programming in javascript became popular with arrival of single page applications and node.js (where most of the operations happen asynchronously by default). Traditionally javascript was handling async operations using callbacks, and at least once every web developer faced a problem called <a href="https://www.google.ca/search?q=callback+hell+definition&amp;tbm=isch" target="_blank" rel="external"><code>callback hell</code></a> or <code>pyramid of doom</code>.</p>
<h2 id="Solutions">Solutions</h2><p>A simple solution is to keep your code shallow, though error handling wouldn’t be that simple. Another one, very well established solution is to use promises. Using ES6 generators we can simplify code for promises and continue writing code in a synchronous, easy to follow, manner, while keeping it asynchronous. If you’re not familiar with how <a href="#promises">promises</a> or <a href="#generators">generators</a> are working, please do a quick research before you continue reading.</p>
<h3 id="co_to_the_rescue">co to the rescue</h3><p>co is a wrapper around promises and generators which allows to simplify asynchronous code a lot. Take a look at the example which shows how an async code could be written in a sync manner using co:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">co(<span class="function"><span class="keyword">function</span>* <span class="title">getResults</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">//assume read and request perform asynchronous actions</span></span><br><span class="line">  <span class="keyword">var</span> a = read(<span class="string">'index.js'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">  <span class="keyword">var</span> b = request(<span class="string">'http://google.ca'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//when all operations will finish </span></span><br><span class="line">  <span class="comment">//res will have contents of index.js at [0]</span></span><br><span class="line">  <span class="comment">//and response body from google at [1]</span></span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b];</span><br><span class="line">  <span class="comment">//...code which does something with res</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span> <span class="params">(ex)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//if an error was thrown from read or request functions</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Here is what co will do for us:</p>
<ul>
<li>Both read and request will execute in parallel on line 7 and when both of them finish - res array will hold results. It doesn’t matter if request finishes before read - co will ensure that results are assigned to appropriate indexes.</li>
<li>On node.js you would have to check for errors in both callbacks for read and request functions, to ensure that your application does not exit in an unhandled state, but with co we can only worry about an end result and add a single error handler using <code>.catch</code>.</li>
<li>Code is rather short and easy to understand</li>
</ul>
<p>So what exactly is happening? How does it work? To understand it better lets go over code of the main function in co and describe it. <a href="https://github.com/tj/co/blob/48ca4dcfa6b6a7396aef57e8d78928cfffc814bc/index.js#L41" target="_blank" rel="external">Open</a> code in new window so that you can put it side by side.</p>
<p>Let`s modify example just a little, in order to show how various scenarios will work in co:<br><figure class="highlight js"><figcaption><span>example.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">co(<span class="function"><span class="keyword">function</span>* <span class="title">getResults</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">//not really doing anything important,</span></span><br><span class="line">  <span class="comment">//but will be useful to show how co works</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ex.message);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//assume read and request perform asynchronous actions</span></span><br><span class="line">  <span class="keyword">var</span> a = read(<span class="string">'index.js'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">  <span class="keyword">var</span> b = request(<span class="string">'http://google.ca'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//when all operations will finish </span></span><br><span class="line">  <span class="comment">//res will have contents of index.js at [0]</span></span><br><span class="line">  <span class="comment">//and response body from google at [1]</span></span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b];</span><br><span class="line">  <span class="comment">//...code, which does something with res</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span> <span class="params">(ex)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//if an error was thrown from read or request functions</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>First co saves context reference, in case you will ever want to use a context inside read or request functions:<br><figure class="highlight js"><figcaption><span>co/index.js:co</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ctx = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Context binding example</span></span><br><span class="line">co.call(context, <span class="function"><span class="keyword">function</span>* <span class="title">getResults</span><span class="params">()</span> </span>&#123;<span class="comment">/*'this' will point to context*/</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>Then it checks, if <code>gen</code> is a function. It it is, then co needs to initialize a generator object by calling a function and it also ensure that <code>this</code> has a proper context. If <code>gen</code> is already a generator object, a statement will be skipped:<br><figure class="highlight js"><figcaption><span>co/index.js:co</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> gen === <span class="string">'function'</span>) gen = gen.call(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></p>
<p>Then co returns a new Promise and runs <code>onFulfilled</code> function with no arguments. Inside that function it will try to execute a generator code until a first <code>yield</code> statement.<br><figure class="highlight js"><figcaption><span>co/index.js:onFulfilled</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ret;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  ret = gen.next(res); <span class="comment">//res is undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In our case following code would execute inside <code>getResults</code> generator:<br><figure class="highlight js"><figcaption><span>example.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>If that code could throw an error - promise would be rejected with an error object and co would exit.<br><figure class="highlight js"><figcaption><span>co/index.js:onFulfilled</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="keyword">return</span> reject(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In our case generator returns an object with a <code>value</code> property containing yielded value and this object is assigned to <code>ret</code>. At that moment of time code would look like that:<br><figure class="highlight js"><figcaption><span>co/index.js:onFulfilled</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ret;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  ret = &#123;value: <span class="literal">false</span>, done: <span class="literal">false</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Then <code>onFulfilled</code> will call <code>next(ret);</code>. If <code>done</code> would be true, co would resolve a promise with the value and exit from next:<br><figure class="highlight js"><figcaption><span>co/index.js:next</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ret.done) <span class="keyword">return</span> resolve(ret.value);</span><br></pre></td></tr></table></figure></p>
<p>Otherwise co attempts to convert <code>ret.value</code> to a promise (we’ll skip <code>toPromise</code> for now). <code>.call</code> is there to provide original context in case <code>ret.value</code> is another <a href="https://github.com/tj/co#yieldables" target="_blank" rel="external">yieldable</a> value:<br><figure class="highlight js"><figcaption><span>co/index.js:next</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> value = toPromise.call(ctx, ret.value);</span><br></pre></td></tr></table></figure></p>
<p>On next line co checks if value is not falsy and if it is a promise, and if so, it adds appropriate handlers for promise fulfilment or rejection and exits from next.<br><figure class="highlight js"><figcaption><span>co/index.js:next</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (value &amp;&amp; isPromise(value)) <span class="keyword">return</span> value.then(onFulfilled, onRejected);</span><br></pre></td></tr></table></figure></p>
<p>Notice how <code>onFulfilled</code>, <code>onRejected</code> and <code>next</code> functions have references to <code>resolve</code> and <code>reject</code> callbacks from a new Promise, which was created at the beginning. If one of these functions calls <code>resolve</code> or <code>reject</code>, then top most promise will be settled. </p>
<p>In our case <code>ret.value</code> in our case is <code>false</code>, so next calls <code>onRejected</code> handler, passes it a new TypeError and exits.<br><figure class="highlight js"><figcaption><span>co/index.js:next</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> onRejected(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'You may only yield a function, promise, generator, array, or object, '</span></span><br><span class="line">        + <span class="string">'but the following object was passed: "'</span> + <span class="built_in">String</span>(ret.value) + <span class="string">'"'</span>));</span><br></pre></td></tr></table></figure></p>
<p><code>onRejected</code> is working quite similar to <code>onFulfilled</code> function with the following difference - instead of running a code until next <code>yield</code> statement, it tries to throw an error inside generator function <em>at the place where it stopped before</em>:<br><figure class="highlight js"><figcaption><span>co/index.js:onRejected</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ret;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  ret = gen.throw(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>That means it will replace <code>yield false</code> with <code>throw err</code> and example would look like this:<br><figure class="highlight js"><figcaption><span>example.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> err; <span class="comment">//err is a TypeError</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(ex.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>That behaviour is completely normal for generators and is described on MDN:<br><blockquote><p>You can force a generator to throw an exception by calling its throw() method and passing the exception value it should throw. This exception will be thrown from the current suspended context of the generator, as if the yield that is currently suspended were instead a throw value statement.</p>
<footer><strong>MDN</strong><cite><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators" target="_blank" rel="external">developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators</a></cite></footer></blockquote><br>At that moment execution flow will get back to example code and, because an error was handled with try-catch, it will be logged in console. Example will continue execution until it will either reach the end of generator or face a new <code>yield</code>:<br><figure class="highlight js"><figcaption><span>example.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = read(<span class="string">'index.js'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"><span class="keyword">var</span> b = request(<span class="string">'http://google.ca'</span>);</span><br><span class="line"><span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b];</span><br></pre></td></tr></table></figure></p>
<p>So result of calling <code>gen.throw</code> in <code>onRejected</code> returns an array with a and b:<br><figure class="highlight js"><figcaption><span>co/index.js:onRejected</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ret;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  ret = &#123;value: [a, b], done: <span class="literal">false</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Catch brunch is skipped but it would otherwise reject the promise. Finally, another next call happens: it would skip immediate resolve, convert array to a promise created with Promise.all (check out <code>arrayToPromise</code> function), which will be settled only when <code>a</code> and <code>b</code> promises are settled or one of them is rejected. Note how <code>arrayToPromise</code> is making sure that Promise.all argument is an array of promises:<br><figure class="highlight js"><figcaption><span>co/index.js:arrayToPromise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj.map(toPromise, <span class="keyword">this</span>)</span><br></pre></td></tr></table></figure></p>
<p><code>toPromise</code> will first check if value is not falsy and if it is, it returns a value:<br><figure class="highlight js"><figcaption><span>co/index.js:toPromise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!obj) <span class="keyword">return</span> obj;</span><br></pre></td></tr></table></figure></p>
<p>If value is a promise already, toPromise will return it:<br><figure class="highlight js"><figcaption><span>co/index.js:toPromise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isPromise(obj)) <span class="keyword">return</span> obj;</span><br></pre></td></tr></table></figure></p>
<p>If value is a generator or a generator function, toPromise will recursively call co, pass it a context and an obj and as a result we will get a new promise:<br><figure class="highlight js"><figcaption><span>co/index.js:toPromise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isGeneratorFunction(obj) || isGenerator(obj)) <span class="keyword">return</span> co.call(<span class="keyword">this</span>, obj);</span><br></pre></td></tr></table></figure></p>
<p>If <code>obj</code> is a function, toPromise will wrap it in a promise. First argument in a function is assumed to be an error object (node.js error handling pattern, so all node js callback APIs are covered):<br><figure class="highlight js"><figcaption><span>co/index.js:toPromise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> obj) <span class="keyword">return</span> thunkToPromise.call(<span class="keyword">this</span>, obj);</span><br></pre></td></tr></table></figure></p>
<p>If <code>obj</code> is an array or an object with <a href="https://github.com/tj/co#yieldables" target="_blank" rel="external">yieldable</a> properties, co will recursively convert them to promises:<br><figure class="highlight js"><figcaption><span>co/index.js:toPromise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) <span class="keyword">return</span> arrayToPromise.call(<span class="keyword">this</span>, obj);</span><br><span class="line"><span class="keyword">if</span> (isObject(obj)) <span class="keyword">return</span> objectToPromise.call(<span class="keyword">this</span>, obj);</span><br></pre></td></tr></table></figure></p>
<p>So co ensures that <code>a</code> and <code>b</code> are converted to promises, and when both promises are fulfilled - Promise.all will ensure that results are assigned to appropriate indexes in an array. If one of them is rejected, then <code>.catch</code> callback from the example will be able to handle an error (log it somewhere, or re-try once again). In either scenario a new Promise (one returned from co at the very beginning) will be settled, code will be executed asynchronously, and in the manner expected by developer, and will have all benefits of central place for error handling.</p>
<p>In a nutshell this is exactly what happens in co: generators and promises take care of asynchronous operations and error handling, while keeping your code clean and easy to follow. Similar logic will be hidden behind a native support of async programming with <a href="https://www.youtube.com/watch?v=DqMFX91ToLw" target="_blank" rel="external">ES7 async-await</a>. If you want to use co, generators and Promises in non ES6 environments, try out 6to5 transpiler (links below).</p>
<p>Thank you and please feel free to ask questions in the comments, follow us on <a href="https://www.facebook.com/webuniverseio" target="_blank" rel="external">facebook</a> and <a href="https://twitter.com/webuniverseio" target="_blank" rel="external">twitter</a> pages, or subscribe to our <a href="/atom.xml">feed</a>.</p>
<h2 id="Links">Links</h2><ul>
<li>co - <a href="https://github.com/tj/co" target="_blank" rel="external">https://github.com/tj/co</a>  </li>
<li>shallow code - <a href="http://exponential.io/blog/unnest-callbacks/" target="_blank" rel="external">http://exponential.io/blog/unnest-callbacks/</a></li>
<li>6to5 transpiler (babeljs) - <a href="https://babeljs.io/docs/learn-es6/" target="_blank" rel="external">https://babeljs.io/docs/learn-es6/</a></li>
</ul>
<h3 id="Promises">Promises<a name="promises"></a></h3><ul>
<li>description - <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="external">https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise</a></li>
<li>support - <a href="http://kangax.github.io/compat-table/es6/#Promise" target="_blank" rel="external">http://kangax.github.io/compat-table/es6/#Promise</a></li>
<li>examples - <a href="http://www.2ality.com/2014/09/es6-promises-foundations.html" target="_blank" rel="external">http://www.2ality.com/2014/09/es6-promises-foundations.html</a></li>
</ul>
<h3 id="Generators">Generators<a name="generators"></a></h3><ul>
<li>description and examples - <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*" target="_blank" rel="external">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*</a></li>
<li>support - <a href="http://kangax.github.io/compat-table/es6/#generators" target="_blank" rel="external">http://kangax.github.io/compat-table/es6/#generators</a></li>
</ul>
<style type="text/css">.article__title {font-size: 1.72rem;}</style>]]></content>
    <summary type="html">
    <![CDATA[<p>This article explains what an npm <code>co</code> module is, how it works and how it can help you to write much cleaner and simpler async]]>
    </summary>
    
  </entry>
  
</feed>